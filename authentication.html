<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenX — Profile Setup</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { max-width: 600px; width: 100%; margin: 30px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        h2 { color: #1877f2; text-align: center; margin-bottom: 20px; }
        label { font-weight: bold; color: #606770; display: block; margin-top: 15px; margin-bottom: 5px; }
        input, select, textarea, button { width: 100%; margin-bottom: 12px; padding: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        button { background: #1877f2; color: white; border: none; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        button:hover { background: #165ec9; }
        .step { display: none; }
        .step.active { display: block; }
        .profile-display { text-align: center; }
        .profile-display img#displayProfile { width: 120px; height: 120px; border-radius: 50%; margin: 10px auto; border: 3px solid #ddd; object-fit: cover; }
        .cover-display { width: 100%; height: 180px; object-fit: cover; border-radius: 10px; margin-bottom: 15px; }
        #displayBio { font-style: italic; color: #555; max-width: 80%; margin: 10px auto; }
        #editBtn { background: #6c757d; }
        #editBtn:hover { background: #5a6268; }
    </style>
</head>
<body>
<div class="container">

    <div class="step active" id="step1">
        <h2>Step 1: Basic Info</h2>
        <input type="text" id="firstName" placeholder="First Name" required>
        <input type="email" id="email" placeholder="Email" required>
        <select id="gender" required>
            <option value="">Select Gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
        </select>
        <input type="date" id="dob" required>
        <button id="next1">Next</button>
    </div>

    <div class="step" id="step2">
        <h2>Step 2: Profile & Cover</h2>
        <label>Profile Picture:</label>
        <input type="file" id="profilePic" accept="image/*">
        <label>Cover Photo:</label>
        <input type="file" id="coverPic" accept="image/*">
        <label>Bio:</label>
        <textarea id="bio" placeholder="Write a short bio..." rows="3"></textarea>
        <button id="next2">Next</button>
    </div>

    <div class="step" id="step3">
        <h2>Step 3: Review & Save</h2>
        <div class="profile-display">
            <img id="displayCover" class="cover-display" src="https://via.placeholder.com/600x180?text=Cover" alt="Cover">
            <img id="displayProfile" src="https://via.placeholder.com/120?text=Avatar" alt="Profile">
            <h3 id="displayName"></h3>
            <p id="displayEmail"></p>
            <p id="displayGender"></p>
            <p id="displayDob"></p>
            <p id="displayBio"></p>
        </div>
        <button id="editBtn">Edit Info</button>
        <button id="saveBtn">Save & View Profile</button>
    </div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
    // --- Firebase Configuration (Provided by User) ---
    const firebaseConfig = {
        apiKey: "AIzaSyAyMhgLjQg9zU1Tq2pFVmRiF_UiOBqPlj0",
        authDomain: "genx-7a5b3.firebaseapp.com",
        projectId: "genx-7a5b3",
        storageBucket: "genx-7a5b3.firebasestorage.app",
        messagingSenderId: "1293731877",
        appId: "1:1293731877:web:a330360ade1db5e68897cc"
    };
    firebase.initializeApp(firebaseConfig);

    // --- Element References ---
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const next1 = document.getElementById('next1');
    const next2 = document.getElementById('next2');
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');

    const firstName = document.getElementById('firstName');
    const email = document.getElementById('email');
    const gender = document.getElementById('gender');
    const dob = document.getElementById('dob');
    const profilePic = document.getElementById('profilePic');
    const coverPic = document.getElementById('coverPic');
    const bio = document.getElementById('bio');

    const displayName = document.getElementById('displayName');
    const displayEmail = document.getElementById('displayEmail');
    const displayGender = document.getElementById('displayGender');
    const displayDob = document.getElementById('displayDob');
    const displayProfile = document.getElementById('displayProfile');
    const displayCover = document.getElementById('displayCover');
    const displayBio = document.getElementById('displayBio');

    // --- State Management ---
    let profileData = {};

    // --- Navigation Logic ---

    // Step 1 (Basic Info) → Step 2 (Media)
    next1.addEventListener('click', () => {
        if (!firstName.value || !email.value || !gender.value || !dob.value) {
            alert('Please fill all required fields!');
            return;
        }
        profileData.name = firstName.value;
        profileData.email = email.value;
        profileData.gender = gender.value;
        profileData.dob = dob.value;

        step1.classList.remove('active');
        step2.classList.add('active');
    });

    // Step 2 (Media) → Step 3 (Review)
    next2.addEventListener('click', () => {
        profileData.bio = bio.value || '';
        
        const filesToUpload = [];
        if (profilePic.files[0]) filesToUpload.push({ type: 'avatar', file: profilePic.files[0] });
        if (coverPic.files[0]) filesToUpload.push({ type: 'cover', file: coverPic.files[0] });

        // Handle case with no new files uploaded
        if (filesToUpload.length === 0) {
            profileData.avatar = profileData.avatar || "https://via.placeholder.com/120?text=Avatar";
            profileData.cover = profileData.cover || "https://via.placeholder.com/600x180?text=Cover";
            showReview();
            step2.classList.remove('active');
            step3.classList.add('active');
            return;
        }

        let uploadsCompleted = 0;
        filesToUpload.forEach(upload => {
            const folder = upload.type === 'avatar' ? 'profiles' : 'covers';
            const fileRef = firebase.storage().ref(`${folder}/${Date.now()}_${upload.file.name}`);
            
            fileRef.put(upload.file).then(snapshot => {
                return snapshot.ref.getDownloadURL();
            }).then(url => {
                profileData[upload.type] = url;
                uploadsCompleted++;
                if (uploadsCompleted === filesToUpload.length) {
                    showReview();
                    step2.classList.remove('active');
                    step3.classList.add('active');
                }
            }).catch(err => {
                console.error("Upload failed:", err);
                alert("An error occurred during file upload. Please try again.");
            });
        });
    });

    // --- Review and Edit ---
    function showReview() {
        displayName.textContent = profileData.name;
        displayEmail.textContent = "Email: " + profileData.email;
        displayGender.textContent = "Gender: " + profileData.gender;
        displayDob.textContent = "Date of Birth: " + profileData.dob;
        displayProfile.src = profileData.avatar;
        displayCover.src = profileData.cover;
        displayBio.textContent = profileData.bio || "No bio provided.";
    }

    // Edit Button: Go back to Step 1 and repopulate fields
    editBtn.addEventListener('click', () => {
        step3.classList.remove('active');
        step1.classList.add('active');

        firstName.value = profileData.name;
        email.value = profileData.email;
        gender.value = profileData.gender;
        dob.value = profileData.dob;
        bio.value = profileData.bio;
    });

    // --- Save and Redirect Logic ---
    saveBtn.addEventListener('click', () => {
        saveBtn.disabled = true; 
        saveBtn.textContent = 'Saving...';

        // Use a timestamp as a unique ID for the user's data record
        const userId = Date.now(); 
        const newUserRef = firebase.database().ref('users/' + userId);

        newUserRef.set(profileData)
            .then(() => {
                // SUCCESS: Save complete, now redirect
                alert('Profile saved successfully! Redirecting to your new profile...');
                
                // Redirect to the profile page, passing the new user's ID
                window.location.href = `profile.html?userId=${userId}`;
            })
            .catch(err => {
                // ERROR: Show message and re-enable button
                alert('Error saving profile: ' + err.message);
                saveBtn.disabled = false; 
                saveBtn.textContent = 'Save & View Profile';
            });
    });
</script>
</body>
</html>
