<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>VisitBook — My Profile</title>
<style>
  body { font-family: "Poppins", Arial, sans-serif; background: #f0f2f5; margin:0; padding:0; }
  .profile-container { max-width:600px; margin:20px auto; background:white; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1); overflow:hidden; }
  .cover-photo { width:100%; height:180px; object-fit:cover; }
  .profile-info { text-align:center; padding:15px; margin-top:-60px; }
  .profile-info img { width:110px; height:110px; border-radius:50%; border:4px solid white; object-fit:cover; }
  .profile-info h2 { margin:10px 0 5px; color:#1877f2; }
  .profile-info p { margin:4px 0; color:#555; }
  .bio { background:#f8f9fa; padding:15px; border-radius:10px; margin:10px; text-align:center; font-style:italic; }
  .btns { text-align:center; margin:15px; }
  .btn { display:inline-block; background:#1877f2; color:white; padding:10px 20px; border-radius:8px; margin:5px; text-decoration:none; font-weight:500; }
  .btn:hover { background:#165ec9; }
  .post-box { padding:15px; border-top:1px solid #ddd; text-align:center; }
  .post-box textarea { width:100%; height:80px; border-radius:8px; border:1px solid #ccc; padding:10px; resize:none; }
  .post-box input[type="file"] { margin-top:8px; }
  .post-box button { margin-top:8px; padding:8px 16px; background:#1877f2; color:#fff; border:none; border-radius:6px; cursor:pointer; }
  .post-box button:hover { background:#155dc9; }
  .post { background:white; margin:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); overflow:hidden; }
  .post-header { display:flex; align-items:center; padding:10px; }
  .post-header img { width:40px; height:40px; border-radius:50%; margin-right:10px; }
  .post-content { padding:10px; }
  .post-content img, .post-content video { width:100%; border-radius:8px; margin-top:10px; }
</style>
</head>
<body>

<div id="profileSection" class="profile-container" style="display:none;">
  <img id="coverImage" class="cover-photo" src="" alt="Cover Photo">
  <div class="profile-info">
    <img id="profileImage" src="" alt="Profile Picture">
    <h2 id="profileName"></h2>
    <p id="profileEmail"></p>
    <p id="profileGender"></p>
    <p id="profileDob"></p>
  </div>
  <div class="bio" id="profileBio"></div>

  <!-- ✏️ Post creation -->
  <div class="post-box">
    <textarea id="postText" placeholder="What's on your mind?"></textarea><br>
    <input type="file" id="postMedia" accept="image/*,video/*"><br>
    <button onclick="createPost()">Post</button>
  </div>

  <!-- 📄 Posts -->
  <div id="postsContainer"></div>

  <div class="btns">
    <a href="edit-profile.html" class="btn">Edit Profile</a>
    <a href="index.html" class="btn" style="background:#42b72a;">Go to Home</a>
  </div>
</div>

<div id="noProfile" class="no-profile">
  <h3>No Profile Found</h3>
  <p>Please set up your profile first.</p>
  <a href="signup.html" class="btn">Create Profile</a>
</div>

<!-- Supabase + Cloudinary -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // --- ⚙️ CONFIGURATIONS ---
  const CLOUD_NAME = 'dnntyhoot';
  const CLOUDINARY_UPLOAD_PRESET = 'unsigned_genxisvisitbook';
  const SUPABASE_URL = 'https://jywisobgiiervzqqbpau.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_goJaWIQJ5jZ9h65wMlzuEw_if0g8BkP';
  const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  // -------------------------

  const profileSection = document.getElementById("profileSection");
  const noProfile = document.getElementById("noProfile");
  const postsContainer = document.getElementById("postsContainer");

  const urlParams = new URLSearchParams(window.location.search);
  const profileId = urlParams.get("id");

  // 🧩 Load profile
  async function loadProfile() {
    if (!profileId) return noProfile.style.display = "block";

    const { data, error } = await client.from("profiles").select("*").eq("id", profileId).single();
    if (error || !data) return noProfile.style.display = "block";

    profileSection.style.display = "block";
    noProfile.style.display = "none";

    document.getElementById("coverImage").src = data.cover_url || "https://via.placeholder.com/600x150";
    document.getElementById("profileImage").src = data.avatar_url || "https://via.placeholder.com/100";
    document.getElementById("profileName").textContent = data.full_name || "Unnamed User";
    document.getElementById("profileEmail").textContent = "Email: " + (data.email || "Not Provided");
    document.getElementById("profileGender").textContent = "Gender: " + (data.gender || "N/A");
    document.getElementById("profileDob").textContent = "DOB: " + (data.date_of_birth || "N/A");
    document.getElementById("profileBio").textContent = data.bio || "No bio added yet.";

    loadPosts();
  }

  // 🖼️ Upload to Cloudinary
  async function uploadToCloudinary(file) {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
    const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, {
      method: "POST",
      body: formData,
    });
    const data = await response.json();
    return data.secure_url;
  }

  // 📝 Create a post
  async function createPost() {
    const text = document.getElementById("postText").value.trim();
    const media = document.getElementById("postMedia").files[0];
    if (!text && !media) return alert("Write something or add media first.");

    let mediaUrl = null;
    if (media) mediaUrl = await uploadToCloudinary(media);

    await client.from("posts").insert([
      { user_id: profileId, content: text, media_url: mediaUrl }
    ]);

    document.getElementById("postText").value = "";
    document.getElementById("postMedia").value = "";
    loadPosts();
  }

  // 📥 Load posts
  async function loadPosts() {
    const { data, error } = await client
      .from("posts")
      .select("*")
      .eq("user_id", profileId)
      .order("created_at", { ascending: false });

    if (error) return console.error("Post load error:", error);

    postsContainer.innerHTML = "";
    data.forEach(post => {
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `
        <div class="post-header">
          <img src="${document.getElementById("profileImage").src}">
          <strong>${document.getElementById("profileName").textContent}</strong>
        </div>
        <div class="post-content">
          <p>${post.content || ""}</p>
          ${post.media_url ? (
            post.media_url.match(/\.mp4|\.webm|\.ogg/)
              ? `<video controls src="${post.media_url}"></video>`
              : `<img src="${post.media_url}">`
          ) : ""}
        </div>
      `;
      postsContainer.appendChild(div);
    });
  }

  loadProfile();
</script>
</body>
</html>
